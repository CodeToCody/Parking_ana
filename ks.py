import pandas as pd

# è®€å–è³‡æ–™
df = pd.read_csv(r"clean_data/prepare.csv")

# å°‡é€²å‡ºæ™‚é–“è½‰ç‚º datetime æ ¼å¼
df["å…¨æ™‚é–“æ ¼å¼é€²å…¥æ™‚é–“"] = pd.to_datetime(df["å…¨æ™‚é–“æ ¼å¼é€²å…¥æ™‚é–“"], errors="coerce")
df["å…¨æ™‚é–“æ ¼å¼å‡ºå ´æ™‚é–“"] = pd.to_datetime(df["å…¨æ™‚é–“æ ¼å¼å‡ºå ´æ™‚é–“"], errors="coerce")

# éæ¿¾åˆæ³•ç´€éŒ„ï¼ˆæœ‰é€²å‡ºæ™‚é–“ï¼Œä¸”å‡ºå ´æ™šæ–¼é€²å ´ï¼‰
df = df.dropna(subset=["å…¨æ™‚é–“æ ¼å¼é€²å…¥æ™‚é–“", "å…¨æ™‚é–“æ ¼å¼å‡ºå ´æ™‚é–“"])
df = df[df["å…¨æ™‚é–“æ ¼å¼å‡ºå ´æ™‚é–“"] > df["å…¨æ™‚é–“æ ¼å¼é€²å…¥æ™‚é–“"]]

# è¨ˆç®—åœç•™æ™‚é–“ï¼ˆå¤©ï¼‰
df["åœç•™æ™‚é–“"] = df["å…¨æ™‚é–“æ ¼å¼å‡ºå ´æ™‚é–“"] - df["å…¨æ™‚é–“æ ¼å¼é€²å…¥æ™‚é–“"]
df["åœç•™å¤©æ•¸"] = df["åœç•™æ™‚é–“"].dt.total_seconds() / 3600 / 24

# ç¯©é¸å‡ºåœç•™è¶…é 30 å¤©çš„è»Šè¼›
df_over_30_days = df[df["åœç•™å¤©æ•¸"] > 30].copy()
df_over_30_days = df_over_30_days.sort_values("åœç•™å¤©æ•¸", ascending=False)

# é¡¯ç¤ºæˆ–è¼¸å‡ºçµæœ
print("ğŸš— åœç•™è¶…é 30 å¤©çš„è»Šè¼›æ•¸é‡ï¼š", len(df_over_30_days))
print(df_over_30_days[["è»Šè™Ÿ", "ç¥¨ç¨®", "å…¨æ™‚é–“æ ¼å¼é€²å…¥æ™‚é–“", "å…¨æ™‚é–“æ ¼å¼å‡ºå ´æ™‚é–“", "åœç•™å¤©æ•¸"]])

df_over_30_days.to_csv("hihi.csv")